<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motorizado Lab - Inicio üèçÔ∏è</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        /* Paleta de Colores: #333 (Negro Motorizado), #FFC107 (Amarillo de Seguridad), #F4F4F9 (Fondo claro) */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px 10px;
            background-color: #f4f4f9;
        }
        #container {
            width: 100%;
            max-width: 900px; 
            margin: auto;
            margin-top: 60px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); /* Sombra m√°s fuerte */
            box-sizing: border-box;
            border-top: 5px solid #FFC107; /* L√≠nea amarilla de impacto */
        }
        h1, h2 {
            color: #333;
            text-align: center;
            font-size: 1.8em;
            text-transform: uppercase;
            border-bottom: 2px solid #FFC107;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        p {
            text-align: center;
            color: #555;
        }
        input[type="file"] {
            display: block;
            margin: 15px auto 25px;
            padding: 10px;
            border: 2px solid #333; /* Borde oscuro */
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
            background-color: #eee;
        }
        .action-buttons {
            text-align: center;
            margin-bottom: 30px;
        }
        .action-buttons button {
            background-color: #333; /* Fondo oscuro */
            color: #FFC107; /* Texto amarillo */
            padding: 12px 25px; 
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            width: 100%; 
            box-sizing: border-box;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.2s ease, transform 0.1s;
        }
        .action-buttons button:hover {
            background-color: #555;
            transform: translateY(-2px);
        }
        .action-buttons button:active {
            transform: translateY(0);
        }
        #status {
            font-size: 1.1em;
            color: #1a4f78;
            padding: 10px;
            border-radius: 5px;
            background-color: #e9f7ff;
            text-align: center;
        }
        /* Estilos de Contenedores de Datos */
        #outputList {
            list-style: none;
            padding: 0;
            margin-top: 25px;
        }
        .company-group {
            margin-bottom: 25px;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid;
            background-color: #ffffff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        /* Colores de Compa√±√≠a (Conservamos diferenciaci√≥n) */
        .company-group.fsfb-blue { border-color: #007bff; background-color: #e6f7ff; }
        .company-group.other-red { border-color: #dc3545; background-color: #ffeaea; }
        
        .company-header {
            font-weight: bold;
            font-size: 1.3em; 
            color: #333;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px dashed #ccc;
        }
        .patient-item {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 12px;
            border-radius: 4px;
        }
        .patient-header {
            font-weight: 700;
            color: #333;
            font-size: 1em;
            margin-bottom: 5px;
        }
        .request-info {
            font-weight: 600;
            color: #666;
            display: block;
            margin-top: 5px;
            font-size: 0.9em;
        }
        .exam-list {
            list-style: disc;
            margin: 5px 0 0 25px;
            padding: 0;
            font-size: 0.9em;
            color: #000;
        }
        .no-exams {
            color: #888;
            font-style: italic;
            margin-left: 25px;
            font-size: 0.9em;
        }

        /* MEDIA QUERY para Desktop */
        @media (min-width: 600px) {
            h1 {
                font-size: 2.5em;
            }
            .action-buttons button {
                width: auto;
                min-width: 350px;
                font-size: 1.1em;
            }
        }
        /* --- ESTILOS DEL BOT√ìN SUPERIOR FIJO Y LLAMATIVO --- */
.back-button {
    position: fixed; 
    top: 15px;
    left: 50%; /* Centrado horizontalmente */
    transform: translateX(-50%); /* Ajuste para centrar */
    z-index: 1000; 
    background-color: #333; /* Color de base (Negro Motorizado) */
    color: #FFC107; /* Color de impacto (Amarillo de Seguridad) */
    padding: 10px 20px; 
    border: 2px solid #FFC107; /* Borde de seguridad */
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9em; 
    font-weight: bold;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
    transition: background-color 0.2s ease, transform 0.1s;
}
.back-button:hover {
    background-color: #555;
    transform: translateX(-50%) scale(1.02);
}
/* Media query para pantallas grandes */
@media (min-width: 600px) {
    .back-button {
        top: 20px;
        padding: 12px 25px;
        font-size: 1em;
    }
}
        
    </style>
</head>
<body>
    <button class="back-button" onclick="window.location.href='https://rmns82839-rgb.github.io/portal-de-toma-de-muestras/'">
    VOLVER AL PORTAL PRINCIPAL
</button>

    <div id="container">
        <h1>Motorizados Lab üß™</h1>
        <p>Sistema de Gesti√≥n de Rutas y Carga CSV</p>

        <input type="file" id="csvFile" accept=".csv" required>

        <div class="action-buttons">
            <button onclick="window.location.href='guia_examenes.html'">VER GU√çA DE TOMA DE MUESTRAS</button>
        </div>

        <h2 id="status"></h2>

        <ul id="outputList">
            </ul>
    </div>

    <script>
        const STORAGE_KEY = 'csv_data_motorizado'; 

        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('csvFile');
            const outputList = document.getElementById('outputList');
            const statusElement = document.getElementById('status');

            loadAndRenderData();

            fileInput.addEventListener('change', handleFileSelect);

            function handleFileSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    statusElement.textContent = "Cargando y analizando datos...";
                    outputList.innerHTML = ''; 
                    
                    Papa.parse(file, {
                        header: true,
                        dynamicTyping: false,
                        skipEmptyLines: true,
                        delimiter: ",", 
                        newline: "",    
                        transformHeader: function(header) {
                            return header.trim().replace(/\s+/g, ' '); 
                        },
                        complete: function(results) {
                            if (results.errors.length > 0) {
                                console.warn("Errores de PapaParse:", results.errors);
                            }
                            statusElement.textContent = "Datos cargados exitosamente. Procesando y guardando...";
                            const processedData = processData(results.data);
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(processedData));
                            renderData(processedData, results.data.length);
                        },
                        error: function(error) {
                            statusElement.textContent = `Error al analizar el archivo: ${error.message}`;
                            console.error('Error al analizar CSV:', error);
                        }
                    });
                }
            }

            function loadAndRenderData() {
                const storedData = localStorage.getItem(STORAGE_KEY);
                if (storedData) {
                    const data = JSON.parse(storedData);
                    renderData(data, 'anteriormente'); 
                    const totalPatients = Object.values(data).reduce((acc, patients) => acc + Object.keys(patients).length, 0);
                    const totalCompanies = Object.keys(data).length;
                    statusElement.textContent = `Ruta cargada desde la √∫ltima sesi√≥n. ${totalPatients} pacientes agrupados en ${totalCompanies} compa√±√≠as.`;
                } else {
                    statusElement.textContent = "Esperando la carga de un archivo CSV de ruta...";
                }
            }

            function processData(data) {
                const companyData = {};
                
                // Mapeo de columnas (Aseg√∫rate que estos nombres coincidan con tu CSV)
                const companyCol = 'Tipo cliente';
                const requestCol = 'N¬∞ Solicitud';
                const docCol = 'N¬∞ Documento';
                const nameCol = 'Nombre Paciente';
                const examsCol = 'Examenes solicitados'; 

                data.forEach(row => {
                    const company = row[companyCol] ? String(row[companyCol]).trim() : 'COMPA√ë√çA DESCONOCIDA';
                    const requestNum = row[requestCol] ? String(row[requestCol]).trim().replace(/\n/g, ' ') : null; 
                    const name = row[nameCol] ? String(row[nameCol]).trim() : 'Paciente Desconocido';
                    const doc = row[docCol] ? String(row[docCol]).trim() : '';
                    const examsString = row[examsCol];

                    if (requestNum && name !== 'Paciente Desconocido' && doc) {
                        
                        const patientKey = `${name} | ${doc}`;
                        
                        if (!companyData[company]) {
                            companyData[company] = {};
                        }

                        if (!companyData[company][patientKey]) {
                            companyData[company][patientKey] = {
                                name: name,
                                doc: doc,
                                requests: []
                            };
                        }
                        
                        let processedExams = [];
                        if (examsString && String(examsString).trim().length > 0) {
                            // Separar los ex√°menes por "//"
                            const exams = String(examsString).split('//').map(exam => exam.trim()).filter(exam => exam.length > 0);
                            const currentExams = new Set();
                            exams.forEach(exam => currentExams.add(exam));
                            processedExams = Array.from(currentExams).sort();
                        }
                        
                        companyData[company][patientKey].requests.push({
                            requestNum: requestNum,
                            exams: processedExams
                        });
                    }
                });
                return companyData;
            }

            function renderData(companyData, totalRowsProcessed) {
                outputList.innerHTML = '';
                let totalPatients = 0;
                
                const sortedCompanies = Object.keys(companyData).sort();

                if (sortedCompanies.length === 0) {
                    statusElement.textContent = "No se encontraron datos v√°lidos con las columnas requeridas.";
                    return;
                }
                
                sortedCompanies.forEach(company => {
                    const companyListItem = document.createElement('li');
                    companyListItem.className = 'company-group';
                    
                    const companyNormalized = company.toUpperCase();
                    if (companyNormalized.includes('FSFB') || companyNormalized.includes('FUNDACION SANTA FE')) {
                        companyListItem.classList.add('fsfb-blue');
                    } else {
                        companyListItem.classList.add('other-red');
                    }
                    
                    const companyHeader = document.createElement('div');
                    companyHeader.className = 'company-header';
                    companyHeader.textContent = `COMPA√ë√çA: ${company}`;
                    companyListItem.appendChild(companyHeader);
                    
                    const patientList = document.createElement('ul');
                    patientList.style.listStyle = 'none';
                    patientList.style.padding = '0';

                    const patientsInCompany = companyData[company];
                    const sortedPatientKeys = Object.keys(patientsInCompany).sort();
                    totalPatients += sortedPatientKeys.length;

                    sortedPatientKeys.forEach(patientKey => {
                        const patientData = patientsInCompany[patientKey];
                        
                        const patientListItem = document.createElement('li');
                        patientListItem.className = 'patient-item';
                        
                        const patientHeader = document.createElement('div');
                        patientHeader.className = 'patient-header';
                        patientHeader.textContent = `PACIENTE: ${patientData.name} (Doc: ${patientData.doc})`;
                        patientListItem.appendChild(patientHeader);

                        patientData.requests.forEach(req => {
                            const reqItem = document.createElement('div');
                            
                            const reqInfo = document.createElement('span');
                            reqInfo.className = 'request-info';
                            reqInfo.textContent = `N¬∞ Solicitud: ${req.requestNum}`;
                            reqItem.appendChild(reqInfo);

                            if (req.exams.length > 0) {
                                const examList = document.createElement('ul');
                                examList.className = 'exam-list';
                                
                                req.exams.forEach(exam => {
                                    const examItem = document.createElement('li');
                                    examItem.textContent = exam;
                                    examList.appendChild(examItem);
                                });
                                reqItem.appendChild(examList);
                            } else {
                                const noExamsMsg = document.createElement('p');
                                noExamsMsg.className = 'no-exams';
                                noExamsMsg.textContent = '‚Äî No se registraron ex√°menes en esta solicitud.';
                                reqItem.appendChild(noExamsMsg);
                            }
                            
                            patientListItem.appendChild(reqItem);
                        });

                        patientList.appendChild(patientListItem);
                    });

                    companyListItem.appendChild(patientList);
                    outputList.appendChild(companyListItem);
                });

                if (totalRowsProcessed !== 'anteriormente') {
                    statusElement.textContent = `Proceso finalizado. Se procesaron ${totalRowsProcessed} filas, encontrando ${totalPatients} pacientes agrupados en ${sortedCompanies.length} compa√±√≠as.`;
                }
            }

        });
    </script>

</body>

</html>
